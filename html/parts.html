<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">

      // TODO: GameObjectのisDestroy_を検出できないエラーを消す
      // TODO: Drawメソッドで自分を表示するのはなんか気持ち悪いので変える
      // TODO: GameManagerを分割する

      // 1秒に60回Updateを行う
      const UPDATEINTERVAL = 1000 / 60;
      // 敵機が1回のUpdateで動く距離
      const ENEMYMOVEDIST  = 20 / 60; 
      // 弾丸が1回のUpdateで動く距離
      const BULLETMOVEDIST = -20; 
      // 敵機があわられる時間
      const ENEMYAPPEARTIME = 3000;
      // 自機の横幅
      const PLAYERWIDTH = 50;
      // 自機の縦幅
      const PLAYERHIGHT = 50;
      // 敵機の横幅
      const ENEMYWIDTH = 50;
      // 敵機の縦幅
      const ENEMYHIGHT = 50;
      // ゲームの制限時間 = 180s
      const PLAYABLETIME = 180000;

      // ゲームを管理するクラス
      class GameManager{
        constructor(){
          this.collection_ = [];
          this.timer_ = new Timer(PLAYABLETIME);
          this.factory_ = new Factory();
        }
        AddCollection(obj){
          this.collection_.push(obj);
        }
        DelCollection(index){
          this.collection_.splice(index, 1);
        }
        // ゲーム内オブジェクトの更新
        ObjectsUpdate(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            obj.Update();
          }
        }
        // 衝突判定
        Collision(){
          var length = this.collection_.length;
          for(var i = 0; i < length - 1; i++) {
            var target = this.collection_[i];
            var centerX4Target = target.leftTopX_ + target.width_ / 2;
            var centerY4Target = target.leftTopY_ + target.height_ / 2;
            for(var j = i + 1; j < length ; j++) {
              var other = this.collection_[j];
              var centerX4Other = other.leftTopX_ + other.width_ / 2;
              var centerY4Other = other.leftTopY_ + other.height_ / 2;
              var widthDecision = (Math.abs(centerX4Target - centerX4Other) < target.width_ / 2 + other.width_ / 2)? true : false;
              var heightDecision = (Math.abs(centerY4Target - centerY4Other) < target.height_ / 2 + other.height_ / 2)? true : false;
              if(widthDecision == false || heightDecision == false){
                continue;
              }
              target.Hit();
              other.Hit();
            }
          }
        }
        // 不要オブジェクトの始末
        Clean(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            // isDestroy_が検出できない時がある
            if(obj.isDestroy_ == false){
              continue;
            }
            obj.self_.parentNode.removeChild(obj.self_);
            this.DelCollection(i);
          }
        }
        // 更新
        Update(){
          this.ObjectsUpdate();
          this.Collision();
          this.Clean();
        }
        Test(){
          if(this.timer_.GetTime() < (100000)){
            this.factory_.CreateBoss(this);
          }else{
            this.factory_.CreateEnemy(this);
          }
        }
      }

      class Factory{
        CreateEnemy(gameManager){
          var enemy = new Enemy(Math.random() * 450 , 0, ENEMYWIDTH, ENEMYHIGHT);
          gameManager.AddCollection(enemy);
        }
        CreateBoss(gameManager){
          const boss = new Boss(250 - 125, -200, 250, 250);
          gameManager.AddCollection(boss);
        }
      }

     
      // オブジェクトのベース
      class BaseObject {
        // 初期位置を指定して生成する
        constructor(leftTopX, leftTopY, width, height){
          this.leftTopX_  = leftTopX;
          this.leftTopY_  = leftTopY;
          this.width_     = width;
          this.height_    = height;
          this.isDestroy_ = false;
          this.self_      = document.createElement("div");
          this.Draw();
        }
        // 自分を描画する
        Draw(){
          // オブジェクトを配置
          var field = document.getElementById("playField");
          if(field == null){
            console.log("in DrawMyself of CharactorBase field is null");
            return;
          }
          field.insertBefore(this.self_, field.firstChild);
          // スタイル設定 
          this.self_.style.position = "absolute";
          this.self_.style.border   = "1px solid black";
          this.self_.style.width    = this.width_  + "px";
          this.self_.style.height   = this.height_ + "px";
          this.self_.style.left     = this.leftTopX_   + "px";
          this.self_.style.top      = this.leftTopY_   + "px";
        }
      }
        
      // ゲーム画面内で使用するオブジェクト(登場人物)
      class GameObject extends BaseObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Move(distX, distY){
          if(this.self_ == null){
            console.log("in Move of CharactorBase self is null");
            return;
          }
          var newLeftTopX = this.leftTopX_ + distX;
          var newLeftTopY = this.leftTopY_ + distY;
          this.self_.style.left = newLeftTopX + "px";
          this.self_.style.top  = newLeftTopY + "px";
          this.leftTopX_ = newLeftTopX;
          this.leftTopY_ = newLeftTopY;
        }
        Hit(){
          this.isDestroy_ = true;
        }
      }

      class Player extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
        }
      }

      class Enemy extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.leftTopY_ >= 400){
            this.isDestroy_ = true;
            return
          }
          this.Move(0, ENEMYMOVEDIST);
        }
      }

      class Bullet extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.leftTopY_ < 0){
            this.isDestroy_ = true;
            return
          }
          this.Move(0, BULLETMOVEDIST);
        }
      }

      // タイマー
      class Timer{
        constructor(playableTime){
          this.timer_ = document.getElementById("timer");
          this.remainTime_ = playableTime;
          this.timeConverter_ = new TimeConverter();
          this.Start();
        }
        Start(){
          var self = this;
          window.setInterval(function(){
            self.Update();
          }, 1000);
        }
        Stop(){
          GameOver();
        }
        Update(){
          this.CountDownRemainTime();
          this.UpdateTimer();
        }
        CountDownRemainTime(){
          if(this.remaiTime_ <= 0){
            this.Stop();
            return;
          }
          this.remainTime_ -= 1000;
        }
        UpdateTimer(){
          var degTime = this.timeConverter_.ConvertMsToDegitalTime(this.remainTime_);
          this.timer_.style.innerText = "あいうえお";
        }
        GetTime(){
          console.log(this.remainTime_);
          return this.remainTime_;
        } 
      }

      // ミリ秒を変換するためのクラス
      // 参考： https://qiita.com/fumix/items/a7f66780c728de95558f
      class TimeConverter{
        ConvertMsToDegitalTime(ms){
          var h = String(Math.floor(ms / 3600000) + 100).substring(1);
          var m = String(Math.floor((ms - h * 3600000)/60000)+ 100).substring(1);
          var s = String(Math.round((ms - h * 3600000 - m * 60000)/1000)+ 100).substring(1);
          return h + ":" + m + ":" + s;
        }
      }

      function GameOver(){
          // 暫定対応
          location.reload();
      }

      class Boss extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
          this.self_.style.borderRadius = "50% 50% 50% 50%";
          //this.self_.style.textContent = "ち";
          this.hitCount_ = 0;
        }
        Update(){
          if(this.leftTopY_ >= 400){
            this.isDestroy_ = true;
            return
          }
          this.Move(0, ENEMYMOVEDIST);
        }
        Hit(){
          if (this.hitCount_ < 50){
            this.hitCount_ += 1;
            return;
          }
          this.isDestroy_ = true;
        }
      }



      $(function(){

        $("#start").on("click",function(){
          // startボタンにフォーカスが当たっていると自機が複製されてしまう
          document.activeElement.blur();
          const gameManager = new GameManager();
          const player = new Player(250 - PLAYERWIDTH / 2, 450, PLAYERWIDTH, PLAYERHIGHT);
          gameManager.AddCollection(player);

          window.setInterval(function(){
            gameManager.Test();
          }, ENEMYAPPEARTIME);

          window.setInterval(function(){
            gameManager.Update();
          }, UPDATEINTERVAL);

          $(window).keydown(function(e){
            // スペースキー 撃つ
            if(e.keyCode == 32){
              var bulletWidth = 5;
              var bulletHeight = 5;
              // 自機の中心に弾を出現させる
              var bulletLeftTopX = player.leftTopX_ +  (player.width_ / 2) - (bulletWidth / 2);
              // 発車した瞬間に自機が死なないようにY座標をテコ入れ
              var bulletLeftTopY = player.leftTopY_ - 10;
              var bullet = new Bullet(bulletLeftTopX, bulletLeftTopY, bulletWidth, bulletHeight);
              gameManager.AddCollection(bullet);
            }
            // <- -> 左右移動
            if (e.keyCode == 37){
              player.Move(-5, 0);
            }
            if (e.keyCode == 39){
              player.Move(+5, 0);
            }
          });



        });

        $("#stop").on("click",function(){
          // 暫定対応
          GameOver();
        });


      });
  </script>
  <style type="text/css">
     body{
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      div{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      } 
      #playField{
        width: 500px;
        height: 500px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="playField"></div>
    <button id="start">start</button>
    <button id="stop">stop</button>
    <div id="timer">a</div>
  </body> 
</html> 

<!-- EOF -->

