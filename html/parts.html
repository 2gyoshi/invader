<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">

      // TODO: 衝突判定の計算精度を上げる
      // TODO: GameObjectのstate_を検出できないエラーを消す

      // 1秒に60回Updateを行う
      const UPDATEINTERVAL = 1000 / 60;
      // 敵機が1回のUpdateで動く距離
      const ENEMYMOVEDIST  = 20 / 60; 
      // 弾丸が1回のUpdateで動く距離
      const BULLETMOVEDIST = -20; 
      // 敵機があわられる時間
      const ENEMYAPPEARTIME = 3000;

      // ゲームを管理するクラス
      class Game{
        constructor(){
          this.collection_ = [];
        }
        AddCollection(obj){
          this.collection_.push(obj);
        }
        DelCollection(index){
          this.collection_.splice(index, 1);
        }
        // ゲーム内オブジェクトの更新
        ObjectsUpdate(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            obj.Update();
          }
        }
        // 衝突判定
        Collision(){
          var length = this.collection_.length;
          for(var i = 0; i < length - 1; i++) {
            for(var j = i + 1; j < length ; j++) {
              var o1 = this.collection_[i];
              var o2 = this.collection_[j];
              // 計算がずれているらしい(特にx軸)
              var widthDecision   = (Math.abs(o1.posX_ - o2.posX_) < o1.width_  / 2 + o2.width_  / 2)? true : false;
              var heightDecision  = (Math.abs(o1.posY_ - o2.posY_) < o1.height_ / 2 + o2.height_ / 2)? true : false;
              if(widthDecision == false || heightDecision == false){
                continue;
              }
              o1.Hit();
              o2.Hit();
            }
          }
        }
        // 不要オブジェクトの始末
        Clean(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            // state_が検出できない時がある
            if(obj.state_ == false){
              obj.self_.parentNode.removeChild(obj.self_);
              this.DelCollection(i);
            }
          }
        }
        // 更新
        Update(){
          this.ObjectsUpdate();
          this.Collision();
          this.Clean()
        }
      }
     
      // オブジェクトのベース
      class BaseObject {
        // 初期位置を指定して生成する
        constructor(posX, posY, width, height){
          this.posX_   = posX;
          this.posY_   = posY;
          this.width_  = width;
          this.height_ = height;
          this.self_   = document.createElement('div');
          this.state_  = true;
          this.Draw();
        }
        // 自分を描画する
        Draw(){
          // オブジェクトを配置
          var field = document.getElementById("playField");
          if(field == null){
            console.log("in DrawMyself of CharactorBase field is null");
            return;
          }
          field.insertBefore(this.self_, field.firstChild);

          // スタイル設定 
          this.self_.style.position = "absolute";
          this.self_.style.border   = "1px solid black";
          this.self_.style.width    = this.width_  + "px";
          this.self_.style.height   = this.height_ + "px";
          this.self_.style.left     = this.posX_   + "px";
          this.self_.style.top      = this.posY_   + "px";
        }
      }
        
      // ゲーム画面内で使用するオブジェクト(登場人物)
      class GameObject extends BaseObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Move(distX, distY){
          if(this.self_ == null){
            console.log("in Move of CharactorBase self is null");
            return;
          }
          var newPosX = this.posX_ + distX;
          var newPosY = this.posY_ + distY;
          this.self_.style.left = newPosX + "px";
          this.self_.style.top  = newPosY + "px";
          this.posX_ = newPosX;
          this.posY_ = newPosY;
        }
        Hit(){
          this.state_ = false;
        }
      }

      class Player extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
        }
      }

      class Enemy extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.posY_ >= 400){
            this.state_ = false;
            return
          }
          this.Move(0, ENEMYMOVEDIST);
        }
      }

      class Bullet extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.posY_ < 0){
            this.state_ = false;
            return
          }
          this.Move(0, BULLETMOVEDIST);
        }

      }

      class Timer{
        constructor(){
          this.remainTime_ = 60 * 1000;
        }
        CountDown(){
          if(this.remainTime_ <= 0){
            return
          }
          this.remainTime_ -= 1000;
          var timer = document.getElementById("timer");
          timer.innerText = this.remainTime_;
        }
        Start(){
          var self = this;
          window.setInterval(function(){
            self.CountDown();
          }, 1000);
        }
        Stop(){
        }
        
      }
      



      $(function(){

        function CreateEnemy(game){
          var enemy = new Enemy(Math.random() * 450 , 0, 50, 50);
          game.AddCollection(enemy);
        }

        $('#start').on('click',function(){
          const game = new Game();
          const player = new Player(200, 450, 50, 50);
          game.AddCollection(player);

          window.setInterval(function(){
            CreateEnemy(game);
          }, ENEMYAPPEARTIME);

          window.setInterval(function(){
            game.Update();
          }, UPDATEINTERVAL);

          $(window).keydown(function(e){
            // スペースキー 撃つ
            if(e.keyCode == 32){
              var bulletWidth = 5;
              var bulletHeight = 5;
              // 自機の中心に弾を出現させる
              var bulletPosX = player.posX_ +  (player.width_ / 2) - (bulletWidth / 2);
              var bulletPosY = player.posY_ - 100;
              var bullet = new Bullet(bulletPosX, bulletPosY, bulletWidth, bulletHeight);
              game.AddCollection(bullet);
            }
            // <- -> 左右移動
            if (e.keyCode == 37){
              player.Move(-5, 0);
            }
            if (e.keyCode == 39){
              player.Move(+5, 0);
            }
          });



        });

        $('#stop').on('click',function(){
          // 暫定対応
          location.reload();
        });


      });
  </script>
  <style type="text/css">
     body{
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      div{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      } 
      #playField{
        width: 500px;
        height: 500px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="playField">
    </div>
    <button id="start">start</button>
    <button id="stop">stop</button>
    <div id="timer">00:00</div>
  </body> 
</html> 

<!-- EOF -->

