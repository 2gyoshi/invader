<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">

      // ERROR: GameObjectのisDestroy_を検出できないエラーを消す

      // 1秒に60回Updateを行う
      const UPDATEINTERVAL = 1000 / 60;
      // 敵機が1回のUpdateで動く距離
      const ENEMYMOVEDIST  = 20 / 60; 
      // 弾丸が1回のUpdateで動く距離
      const BULLETMOVEDIST = -20; 
      // 敵機があわられる時間
      const ENEMYAPPEARTIME = 3000;
      // 自機の横幅
      const PLAYERWIDTH = 50;
      // 自機の縦幅
      const PLAYERHIGHT = 50;
      // 敵機の横幅
      const ENEMYWIDTH = 50;
      // 敵機の縦幅
      const ENEMYHIGHT = 50;

      // ゲームを管理するクラス
      class GameManager{
        constructor(){
          this.collection_ = [];
        }
        AddCollection(obj){
          this.collection_.push(obj);
        }
        DelCollection(index){
          this.collection_.splice(index, 1);
        }
        // ゲーム内オブジェクトの更新
        ObjectsUpdate(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            obj.Update();
          }
        }
        // 衝突判定
        Collision(){
          var length = this.collection_.length;
          for(var i = 0; i < length - 1; i++) {
            var target = this.collection_[i];
            var centerX4Target = target.leftTopX_ + target.width_ / 2;
            var centerY4Target = target.leftTopY_ + target.height_ / 2;
            for(var j = i + 1; j < length ; j++) {
              var other = this.collection_[j];
              var centerX4Other = other.leftTopX_ + other.width_ / 2;
              var centerY4Other = other.leftTopY_ + other.height_ / 2;
              var widthDecision = (Math.abs(centerX4Target - centerX4Other) < target.width_ / 2 + other.width_ / 2)? true : false;
              var heightDecision = (Math.abs(centerY4Target - centerY4Other) < target.height_ / 2 + other.height_ / 2)? true : false;
              if(widthDecision == false || heightDecision == false){
                continue;
              }
              target.Hit();
              other.Hit();
            }
          }
        }
        // 不要オブジェクトの始末
        Clean(){
          var length = this.collection_.length;
          for(var i = 0; i < length; i++) {
            var obj = this.collection_[i];
            // isDestroy_が検出できない時がある
            if(obj.isDestroy_ == false){
              continue;
            }
            obj.self_.parentNode.removeChild(obj.self_);
            this.DelCollection(i);
          }
        }
        // 更新
        Update(){
          this.ObjectsUpdate();
          this.Collision();
          this.Clean();
        }
      }
     
      // オブジェクトのベース
      class BaseObject {
        // 初期位置を指定して生成する
        constructor(leftTopX, leftTopY, width, height){
          this.leftTopX_  = leftTopX;
          this.leftTopY_  = leftTopY;
          this.width_     = width;
          this.height_    = height;
          this.isDestroy_ = false;
          this.self_      = document.createElement('div');
          this.Draw();
        }
        // 自分を描画する
        Draw(){
          // オブジェクトを配置
          var field = document.getElementById("playField");
          if(field == null){
            console.log("in DrawMyself of CharactorBase field is null");
            return;
          }
          field.insertBefore(this.self_, field.firstChild);
          // スタイル設定 
          this.self_.style.position = "absolute";
          this.self_.style.border   = "1px solid black";
          this.self_.style.width    = this.width_  + "px";
          this.self_.style.height   = this.height_ + "px";
          this.self_.style.left     = this.leftTopX_   + "px";
          this.self_.style.top      = this.leftTopY_   + "px";
        }
      }
        
      // ゲーム画面内で使用するオブジェクト(登場人物)
      class GameObject extends BaseObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Move(distX, distY){
          if(this.self_ == null){
            console.log("in Move of CharactorBase self is null");
            return;
          }
          var newLeftTopX = this.leftTopX_ + distX;
          var newLeftTopY = this.leftTopY_ + distY;
          this.self_.style.left = newLeftTopX + "px";
          this.self_.style.top  = newLeftTopY + "px";
          this.leftTopX_ = newLeftTopX;
          this.leftTopY_ = newLeftTopY;
        }
        Hit(){
          this.isDestroy_ = true;
        }
      }

      class Player extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
        }
      }

      class Enemy extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.leftTopY_ >= 400){
            this.isDestroy_ = true;
            return
          }
          this.Move(0, ENEMYMOVEDIST);
        }
      }

      class Bullet extends GameObject {
        constructor(x, y, w, h){
          super(x, y, w, h);
        }
        Update(){
          if(this.leftTopY_ < 0){
            this.isDestroy_ = true;
            return
          }
          this.Move(0, BULLETMOVEDIST);
        }
      }

      // 作りかけ(放置中)
      class Timer{
        constructor(){
          this.remainTime_ = 60 * 1000;
        }
        CountDown(){
          if(this.remainTime_ <= 0){
            return
          }
          this.remainTime_ -= 1000;
          var timer = document.getElementById("timer");
          timer.innerText = this.remainTime_;
        }
        Start(){
          var self = this;
          window.setInterval(function(){
            self.CountDown();
          }, 1000);
        }
        Stop(){
        }
      }
      
      // 作りかけ(放置中)
      class ScoreManager extends BaseObject{
        constructor(){
          this.score = 0;
        }
        ShowScore(){}
        UpdateScore(){}
      }



      $(function(){

        function CreateEnemy(gameManager){
          var enemy = new Enemy(Math.random() * 450 , 0, ENEMYWIDTH, ENEMYHIGHT);
          gameManager.AddCollection(enemy);
        }

        $('#start').on('click',function(){
          // startボタンにフォーカスが当たっていると自機が複製されてしまう
          document.activeElement.blur();
          const gameManager = new GameManager();
          const player = new Player(200, 450, PLAYERWIDTH, PLAYERHIGHT);
          gameManager.AddCollection(player);

          window.setInterval(function(){
            CreateEnemy(gameManager);
          }, ENEMYAPPEARTIME);

          window.setInterval(function(){
            gameManager.Update();
          }, UPDATEINTERVAL);

          $(window).keydown(function(e){
            // スペースキー 撃つ
            if(e.keyCode == 32){
              var bulletWidth = 5;
              var bulletHeight = 5;
              // 自機の中心に弾を出現させる
              var bulletLeftTopX = player.leftTopX_ +  (player.width_ / 2) - (bulletWidth / 2);
              // 発車した瞬間に自機が死なないようにY座標をテコ入れ
              var bulletLeftTopY = player.leftTopY_ - 10;
              var bullet = new Bullet(bulletLeftTopX, bulletLeftTopY, bulletWidth, bulletHeight);
              gameManager.AddCollection(bullet);
            }
            // <- -> 左右移動
            if (e.keyCode == 37){
              player.Move(-5, 0);
            }
            if (e.keyCode == 39){
              player.Move(+5, 0);
            }
          });



        });

        $('#stop').on('click',function(){
          // 暫定対応
          location.reload();
        });


      });
  </script>
  <style type="text/css">
     body{
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      div{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      } 
      #playField{
        width: 500px;
        height: 500px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="playField">
    </div>
    <button id="start">start</button>
    <button id="stop">stop</button>
    <div id="timer">00:00</div>
  </body> 
</html> 

<!-- EOF -->

